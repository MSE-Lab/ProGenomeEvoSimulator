# ğŸ› ç´¢å¼•è¶Šç•Œé—®é¢˜ä¿®å¤æ€»ç»“

## é—®é¢˜æè¿°

åœ¨è¿è¡Œ `demo_unified_engine.py` æ—¶å‡ºç°äº†ä»¥ä¸‹é”™è¯¯ï¼š

```
âŒ Error in process 1: index 1137 is out of bounds for axis 0 with size 1137
âŒ Error in process 8: index 962 is out of bounds for axis 0 with size 962
```

## ğŸ” é—®é¢˜åˆ†æ

### é”™è¯¯ç±»å‹
- **ç´¢å¼•è¶Šç•Œé”™è¯¯**: è¯•å›¾è®¿é—®ç´¢å¼•1137ï¼Œä½†æ•°ç»„å¤§å°åªæœ‰1137ï¼ˆæœ‰æ•ˆç´¢å¼•åº”è¯¥æ˜¯0-1136ï¼‰
- **å‘ç”Ÿä½ç½®**: å¹¶è¡Œå¤„ç†è¿‡ç¨‹ä¸­çš„ç‚¹çªå˜æœºåˆ¶
- **æ ¹æœ¬åŸå› **: Off-by-oneé”™è¯¯ï¼Œåœ¨è®¡ç®—çƒ­ç‚¹ä½ç½®æ—¶æ²¡æœ‰æ­£ç¡®å¤„ç†è¾¹ç•Œæ¡ä»¶

### é—®é¢˜æ ¹æº

1. **çƒ­ç‚¹ä½ç½®è®¡ç®—é”™è¯¯**:
   ```python
   # åŸå§‹ä»£ç  - æœ‰é—®é¢˜
   hotspot_positions.update(range(i, i + motif_len))
   ```
   å½“ `i + motif_len` ç­‰äºåŸºå› é•¿åº¦æ—¶ï¼Œä¼šäº§ç”Ÿç­‰äºåŸºå› é•¿åº¦çš„ç´¢å¼•

2. **æ•°ç»„è®¿é—®è¶Šç•Œ**:
   ```python
   # åŸå§‹ä»£ç  - æœ‰é—®é¢˜
   rates[hotspot_array] *= self.hotspot_multiplier
   ```
   `rates` æ•°ç»„å¤§å°ä¸º `gene.length`ï¼Œä½† `hotspot_array` ä¸­å¯èƒ½åŒ…å«ç­‰äº `gene.length` çš„ç´¢å¼•

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### 1. ä¿®å¤çƒ­ç‚¹ä½ç½®è®¡ç®—

**æ–‡ä»¶**: `mechanisms/point_mutation_optimized.py`

**ä¿®å¤å‰**:
```python
def _find_hotspot_positions_cached(self, gene: Gene) -> Set[int]:
    # ... 
    for i in range(len(sequence) - motif_len + 1):
        if sequence[i:i + motif_len] == motif:
            hotspot_positions.update(range(i, i + motif_len))  # å¯èƒ½è¶Šç•Œ
```

**ä¿®å¤å**:
```python
def _find_hotspot_positions_cached(self, gene: Gene) -> Set[int]:
    # ...
    for i in range(max(0, sequence_length - motif_len + 1)):
        if i + motif_len <= sequence_length and sequence[i:i + motif_len] == motif:
            # ç¡®ä¿ä¸è¶…å‡ºåŸºå› é•¿åº¦
            motif_positions = range(i, min(i + motif_len, sequence_length))
            hotspot_positions.update(motif_positions)
```

### 2. ä¿®å¤çªå˜ç‡è®¡ç®—

**ä¿®å¤å‰**:
```python
def _calculate_batch_mutation_rates(self, gene: Gene) -> np.ndarray:
    # ...
    hotspot_array = np.array(list(hotspot_positions))
    rates[hotspot_array] *= self.hotspot_multiplier  # å¯èƒ½è¶Šç•Œ
```

**ä¿®å¤å**:
```python
def _calculate_batch_mutation_rates(self, gene: Gene) -> np.ndarray:
    # ...
    # è¿‡æ»¤æ‰è¶…å‡ºåŸºå› é•¿åº¦çš„ä½ç½®ï¼Œé˜²æ­¢ç´¢å¼•è¶Šç•Œ
    valid_positions = [pos for pos in hotspot_positions if pos < gene.length]
    if valid_positions:
        hotspot_array = np.array(valid_positions)
        rates[hotspot_array] *= self.hotspot_multiplier
```

## âœ… ä¿®å¤éªŒè¯

### æµ‹è¯•ç”¨ä¾‹
åˆ›å»ºäº† `test_index_fix.py` æ¥éªŒè¯ä¿®å¤æ•ˆæœï¼š

1. **çƒ­ç‚¹ä½ç½®æµ‹è¯•**: éªŒè¯çƒ­ç‚¹ä½ç½®è®¡ç®—ä¸ä¼šäº§ç”Ÿè¶Šç•Œç´¢å¼•
2. **å¹¶è¡Œå¤„ç†æµ‹è¯•**: éªŒè¯å¤§è§„æ¨¡å¹¶è¡Œè¿›åŒ–ä¸ä¼šå‡ºç°ç´¢å¼•é”™è¯¯
3. **è¾¹ç•Œæ¡ä»¶æµ‹è¯•**: æµ‹è¯•å„ç§åŸºå› é•¿åº¦å’Œåºåˆ—ç»„åˆ

### é¢„æœŸç»“æœ
- âœ… ä¸å†å‡ºç° "index X is out of bounds" é”™è¯¯
- âœ… å¹¶è¡Œå¤„ç†æ­£å¸¸è¿è¡Œ
- âœ… çƒ­ç‚¹çªå˜åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- âœ… æ‰€æœ‰ç”Ÿç‰©å­¦åŠŸèƒ½ä¿æŒå®Œæ•´

## ğŸ¯ å½±å“èŒƒå›´

### ä¿®å¤çš„åŠŸèƒ½
- **å¹¶è¡Œç‚¹çªå˜å¤„ç†**: ç°åœ¨å¯ä»¥å®‰å…¨åœ°åœ¨å¤šè¿›ç¨‹ç¯å¢ƒä¸­è¿è¡Œ
- **çƒ­ç‚¹çªå˜**: çƒ­ç‚¹ä½ç½®è®¡ç®—æ›´åŠ å¥å£®
- **å¤§è§„æ¨¡æ¨¡æ‹Ÿ**: æ”¯æŒå¤„ç†å¤§å‹åŸºå› ç»„ï¼ˆ1000+åŸºå› ï¼‰

### ä¸å—å½±å“çš„åŠŸèƒ½
- ä¸²è¡Œå¤„ç†æ¨¡å¼
- å…¶ä»–è¿›åŒ–æœºåˆ¶ï¼ˆHGTã€é‡ç»„ã€åŸºå› ä¸¢å¤±ï¼‰
- åŸºå› ç»„ç»Ÿè®¡å’Œå¯è§†åŒ–

## ğŸ“Š æ€§èƒ½å½±å“

ä¿®å¤åçš„ä»£ç ï¼š
- **å®‰å…¨æ€§**: æ¶ˆé™¤äº†ç´¢å¼•è¶Šç•Œé£é™©
- **æ€§èƒ½**: æ·»åŠ çš„è¾¹ç•Œæ£€æŸ¥å¯¹æ€§èƒ½å½±å“å¾®ä¹å…¶å¾®
- **ç¨³å®šæ€§**: æé«˜äº†å¹¶è¡Œå¤„ç†çš„ç¨³å®šæ€§

## ğŸ”® é¢„é˜²æªæ–½

ä¸ºé˜²æ­¢ç±»ä¼¼é—®é¢˜å†æ¬¡å‘ç”Ÿï¼š

1. **è¾¹ç•Œæ£€æŸ¥**: åœ¨æ‰€æœ‰æ•°ç»„è®¿é—®å‰æ·»åŠ è¾¹ç•ŒéªŒè¯
2. **å•å…ƒæµ‹è¯•**: ä¸ºå…³é”®å‡½æ•°æ·»åŠ è¾¹ç•Œæ¡ä»¶æµ‹è¯•
3. **ä»£ç å®¡æŸ¥**: é‡ç‚¹å…³æ³¨ç´¢å¼•è®¡ç®—å’Œæ•°ç»„è®¿é—®
4. **ç±»å‹æç¤º**: ä½¿ç”¨æ›´ä¸¥æ ¼çš„ç±»å‹æ³¨è§£

## ğŸ“ æ€»ç»“

è¿™æ¬¡ä¿®å¤è§£å†³äº†ä¸€ä¸ªå…³é”®çš„å¹¶è¡Œå¤„ç†ç¨³å®šæ€§é—®é¢˜ï¼Œç¡®ä¿äº†ï¼š
- ğŸ”’ **å®‰å…¨æ€§**: æ¶ˆé™¤ç´¢å¼•è¶Šç•Œé£é™©
- ğŸš€ **æ€§èƒ½**: å¹¶è¡Œå¤„ç†æ­£å¸¸å·¥ä½œ
- ğŸ§¬ **åŠŸèƒ½**: æ‰€æœ‰ç”Ÿç‰©å­¦æœºåˆ¶ä¿æŒå®Œæ•´
- ğŸ“ˆ **æ‰©å±•æ€§**: æ”¯æŒæ›´å¤§è§„æ¨¡çš„æ¨¡æ‹Ÿ

ä¿®å¤åçš„ç³»ç»Ÿç°åœ¨å¯ä»¥å®‰å…¨åœ°å¤„ç†å¤§å‹åŸºå› ç»„çš„å¹¶è¡Œè¿›åŒ–æ¨¡æ‹Ÿï¼Œä¸ºç”¨æˆ·æä¾›æ›´ç¨³å®šå¯é çš„ä½“éªŒã€‚